<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>AgroPico – Mapa con NDVI y Clima</title>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <style>
    body { font-family: 'Open Sans', Arial, sans-serif; font-size: 14px; margin: 20px; background: #f9f9f9; }
    h1 { font-weight: 600; color: #2c3e50; }
    #map { height: 500px; width: 100%; max-width: 900px; margin-top: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.15); }
    .layers-control { background: white; padding: 8px; border-radius: 6px; position: absolute; top: 15px; right: 15px; z-index: 1000; font-size: 14px; }
    .layers-control label { display: block; margin-bottom: 6px; }
    #weather { margin-top: 15px; padding: 10px; background: white; border-radius: 8px; box-shadow: 0 0 6px rgba(0,0,0,0.1); max-width: 300px; }
    #weather h2 { margin-top: 0; font-size: 16px; color: #2c3e50; font-weight: 600; }
  </style>
</head>
<body>
  <h1>Mapa Satelital con NDVI y Clima</h1>

  <div id="map"></div>
  <div class="layers-control">
    <label><input type="checkbox" id="ndviToggle"> Mostrar capa NDVI</label>
  </div>

  <div id="weather">
    <h2>Clima actual y lluvias</h2>
    <div id="weatherInfo">Cargando...</div>
  </div>

  <script>
    // Iniciar mapa
    const map = L.map('map').setView([-36.6167, -64.2833], 9);

    // Capa base satelital (ESRI)
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles © Esri'
    }).addTo(map);

    // Capa NDVI gratuita (OpenLandMap)
    const ndviLayer = L.tileLayer('https://tiles.openlandmap.org/ndvi/{z}/{x}/{y}.png', {
      attribution: 'NDVI - OpenLandMap',
      opacity: 0.6,
      maxZoom: 18
    });

    document.getElementById('ndviToggle').addEventListener('change', function(){
      if(this.checked) map.addLayer(ndviLayer);
      else map.removeLayer(ndviLayer);
    });

    // Función para mostrar clima/lluvias
    const weatherDiv = document.getElementById('weatherInfo');
    fetch('https://api.open-meteo.com/v1/forecast?latitude=-36.6167&longitude=-64.2833&current_weather=true&hourly=rain&timezone=auto')
      .then(res => res.json())
      .then(data => {
        const cw = data.current_weather;
        const nextRain = data.hourly.time.find((t,i) => data.hourly.rain[i] > 0);
        weatherDiv.innerHTML = `
          <strong>${cw.temperature} °C</strong>,
          viento ${cw.windspeed} km/h<br>
          <em>${cw.weathercode}</em><br>
          ${nextRain ? `Próxima lluvia: ${nextRain}` : 'Sin lluvia prevista hoy'}
        `;
      })
      .catch(() => { weatherDiv.textContent = 'Error al cargar clima'; });
  </script>
</body>
</html>
